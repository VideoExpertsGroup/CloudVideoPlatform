
/* CloudCameraList implementation */

window.CloudCameraList = window.CloudCameraList || {};
window.CloudCameraList.cache = window.CloudCameraList.cache || {}
window.CloudCameraList.config = window.CloudCameraList.config || {}

CloudCameraList.config.slide = {
	width:220,
	height: 220,
	color:'#3788b1',
	radius: 10,
	padding: '18px',
	margin : '10px',
	image : {
		width:184,
		height:131
	}
}
        
CloudCameraList.initialize = function(element){
	CloudCameraList.container = $(element);
	// this.container.attr('id','transition_disabled');
	CloudCameraList.slides = new Array();
	CloudCameraList.pager = new Array();
	CloudCameraList.structure = null;
	CloudCameraList.currentPosition = 0;
	CloudCameraList.hideArrows = 0;
	$(window).on('resize',CloudCameraList.resizeHandler);
	// try render and start updating list
	CloudCameraList.render();
	CloudCameraList.startUpdatingCamList();
}

CloudCameraList.dispose = function(){
	CloudCameraList.stopUpdatingCamList();
	CloudCameraList.slides = new Array();
	CloudCameraList.pager = new Array();
	CloudCameraList.structure = null;
	CloudCameraList.currentPosition = 0;
	CloudCameraList.hideArrows = 0;
	if(CloudCameraList.container){
		CloudCameraList.container.html('');
	}
}

CloudCameraList.render = function(){
	console.log('[SLIDER] render');
	CloudCameraList.drawThrobber();
	CloudCameraList.createWrapper();
	CloudAPI.camerasList().done(function(data){
		CloudCameraList.structure = data.objects;
		if(cc.sort_cameralist){
			console.log('sort_cameralist');
			data.objects.sort(cc.sort_cameralist)
		}
		CloudCameraList.calcSizes();
		CloudCameraList.resizeHandler();
		CloudCameraList.drawSlides();
		CloudCameraList.bindEvents();
		CloudCameraList.updatePreview();
	}).fail(function(r){
		console.error(r);
		if(r.status && r.status == 401){
			CloudCameraList.unauthorizedFail();
		}
	});
}

CloudCameraList.drawThrobber = function(){
	CloudCameraList.container.html('<div class="throbber-wrapper"><span class="spinner gray" style="margin: 0px auto; transition: transform 0ms;"></div></div>');
}

CloudCameraList.hideThrobber = function(){
	CloudCameraList.container.find('.throbber-wrapper').css('display','none');
}

CloudCameraList.createWrapper = function(){
	// TODO if defined in cc.package_sample
	CloudCameraList.container.append(''
		+ (cc.is_package_sample ? '<div class="addcamera" id="addcamera"></div>' : '')
		+ '<div class="slider_wrapper" id="transition_disabled">'
		+	'<div class=slider">'
		+	'<div class="margin-l" style="width: 52px; float: left; height: 100px;"><span class="arrow left" style="display:none; width:30px; height:40px; float:right;margin-top: 100px; background-image: url('+'files/images/left_arrow.png'+');margin-right: 40px;cursor: pointer; background-repeat: no-repeat; background-position: center center;"></span></div>' +
				'<div class="slides" style="overflow:hidden; float:left"><div class="slide-wrapper" style="position:relative;width:826%;transition: all 800ms;"></div></div>' +
				'<div class="margin-r" style="width: 52px; float: left; height: 100px;"><span class="arrow right" style="display:none; width:30px; height:40px; float:left;margin-top: 100px;background-image: url('+'files/images/right_arrow.png'+');margin-left: 40px;cursor: pointer; background-repeat: no-repeat; background-position: center center;"></span></div>' +
			'</div>' +
			'<div style="clear: both;"></div> <div class="pager"></div>' +
		'</div>'
	);
}

CloudCameraList.drawPager = function(){
	var self = this;
	var cntr = CloudCameraList.container.find('.pager');
	cntr.html('');
	if(parseInt(CloudCameraList.slides.length / CloudCameraList.perPage)){
		for(var i=0; i < (CloudCameraList.slides.length / CloudCameraList.perPage); i++){
			el = $('<i class="page-icon" ></i>');
			el.data('page', i);
			if (i == CloudCameraList.currentPosition) {
				el.addClass('active');
			}
			el.click(function(){ CloudCameraList.currentPosition = $(this).data('page');  CloudCameraList.page($(this).data('page'))});
			cntr.append(el);
		}
	}
}

CloudCameraList.drawArrows = function(){
	CloudCameraList.container.find('.arrow').css('display', 'none');
	if(CloudCameraList.currentPosition != 0){
		CloudCameraList.container.find('.left').css('display', 'block');
	}if(CloudCameraList.container.find('.pager i').length && CloudCameraList.currentPosition != CloudCameraList.container.find('.pager i').last().data('page')){
		CloudCameraList.container.find('.right').css('display', 'block');
	}
}

CloudCameraList.changeActivePage = function(){
	var arr = CloudCameraList.container.find('.pager i');
	arr.removeClass('active');
	arr.each(function(el,i)     {
		if(el == CloudCameraList.currentPosition){
			$(i).addClass('active')
		}
	});
	CloudCameraList.drawArrows();
}

CloudCameraList.page = function(pos){
	CloudCameraList.container.find('.slide-wrapper').css('transform',CloudCameraList.calcTransform(pos));
	CloudCameraList.changeActivePage(CloudCameraList.currentPosition);
}

CloudCameraList.pageLeft = function(){
	CloudCameraList.currentPosition  != 0 ? CloudCameraList.currentPosition -= 1 : CloudCameraList.currentPosition = parseInt(CloudCameraList.slides.length / CloudCameraList.perPage);
	CloudCameraList.page(CloudCameraList.currentPosition);
}

CloudCameraList.pageRight = function(){
	CloudCameraList.currentPosition != parseInt((CloudCameraList.slides.length -1) / CloudCameraList.perPage) ? CloudCameraList.currentPosition += 1: CloudCameraList.currentPosition = 0 ;
	CloudCameraList.page(CloudCameraList.currentPosition);

}

CloudCameraList.calcTransform = function(page){
	return "translateX(-" + ((CloudCameraList.perPage * 240 *  page) )+ "px)";
}

CloudCameraList.fixView = function(){
	CloudCameraList.container.find('.slide-wrapper').width(CloudCameraList.sliderWidth);
	if(CloudCameraList.hideArrows || window.isFramed){
		CloudCameraList.container.find('.margin-l').hide();
		CloudCameraList.container.find('.margin-r').hide();
		CloudCameraList.container.find('.pager').css('display','none');
		CloudCameraList.container.find('.slide-wrapper').css('transform',CloudCameraList.calcTransform(CloudCameraList.currentPosition));
		CloudCameraList.container.find('.slide').css('float','none');
	}else{
		CloudCameraList.container.find('.slide-wrapper').width(CloudCameraList.slides.length * 240);
		CloudCameraList.container.find('.margin-l').show();
		CloudCameraList.container.find('.margin-r').show();
		CloudCameraList.container.find('.pager').css('display','');
		CloudCameraList.currentPosition = 0;
		CloudCameraList.container.find('.slide-wrapper').css('transform',CloudCameraList.calcTransform(CloudCameraList.currentPosition));
		CloudCameraList.container.find('.slide').css('float','left');
	}
}

CloudCameraList.setCameraPreviews = function(){
	CloudCameraList.container.find(".slide").each(function(){
		var slide = this;
		var camId = $(this).data('cid');
		var cam = CloudCameraList.structure.filter(function(el){if(el.id == camId){return true}else {return false}})[0];
	});
}

CloudCameraList.drawSlides = function (){
	var cnt = CloudCameraList.container.find('.slider_wrapper .slides .slide-wrapper');
	if(CloudCameraList.slides.length){
		_.each(CloudCameraList.slides, function(el){cnt.append(el.render())});
		CloudCameraList.setCameraPreviews();
		CloudCameraList.container.find('.slide-wrapper').css({
			'overflow-y': 'auto',
			'overflow-x': 'hidden',
			'width': CloudCameraList.slides.length * 240,
			'max-height': $(document).height() - 47
		});
		CloudCameraList.fixView();
		CloudCameraList.drawPager();
	}else{
		CloudCameraList.container.css('width','220px').find('.slider_wrapper').html('').append($('<div class="empty-cameras">'
			+ '<div style="display: table-cell; vertical-align: middle;">'
			+ CloudUI.polyglot.t("no_cameras")
			+ '</div>'
			+ '</div>'
		));
	}
}

CloudCameraList.bindEvents = function () {
	CloudCameraList.drawArrows();
	CloudCameraList.container.remove('id');
	CloudCameraList.clickState = false;
	CloudCameraList.container.find('.slider_wrapper').remove('id');
	CloudCameraList.container.find('.left').click(function(){CloudCameraList.pageLeft()});
	CloudCameraList.container.find('.right').click(function(){CloudCameraList.pageRight()});
	CloudCameraList.hideThrobber();
	CloudCameraList.container.find('.slide img').click(function(){
		if(!CloudCameraList.clickState) {
			CloudCameraList.clickState = true;
			var cid = $(this).closest('.slide').data('cid')
			var cam = CloudCameraList.structure.filter(function (el) {
				if (el.id == cid) {
					return true
				} else {
					return false
				}
			});
			CloudAPI.setCameraID(cam[0].id);
			console.log('selection camera ', CloudAPI.cache.cameraInfo());
			CloudUI.event.trigger(CloudUI.event.CAMERA_SELECTED, [CloudAPI.cache.cameraInfo() || cam]);
		}
	});
	CloudCameraList.container.find('#addcamera').unbind().bind('click',function(){
		app.createDialogModal({
			'title' : app.polyglot.t('dialog_title_create_camera'),
			'content' : app.polyglot.t('dialog_content_create_camera').replace(new RegExp("%S%",'g'), '#' + CloudAPI.cache.account.id +  ' ' + CloudAPI.cache.account.name),
			'buttons' : [
				{text: app.polyglot.t('Close'), close: true}
			],
			'beforeClose' : function() {
			}
		});
	});
}

CloudCameraList.resizeHandler = function() {
	$('.slider_wrapper .slides .slide-wrapper').css({'max-height': $(document).height() - 47});
	if(!CloudCameraList.slides.length){
		return;
	}
	CloudCameraList.winWidth = $(document).width() / 1.5;
	if (CloudCameraList.winWidth < 344) {
		CloudCameraList.winWidth = 344;
	}
	if (CloudCameraList.winWidth > ((240 * 3) + 104)) {
		CloudCameraList.winWidth = ((240 * 3) + 104);
	}
	CloudCameraList.sliderWidth = 0;
	CloudCameraList.perPage = parseInt((CloudCameraList.winWidth - 104) / 240);
	switch (CloudCameraList.perPage) {
		case 1 :
			CloudCameraList.sliderWidth = CloudCameraList.perPage * 240;
			CloudCameraList.hideArrows =1;
			break
		default :
			CloudCameraList.hideArrows = 0;
			CloudCameraList.sliderWidth = CloudCameraList.perPage * 240 + 104;
	}
	if(CloudCameraList.slides.length < 3 && CloudCameraList.perPage == 3) {
		CloudCameraList.hideArrows = 0;
		CloudCameraList.sliderWidth = (CloudCameraList.slides.length * 240 + 104);
	}
	CloudCameraList.container.find('.slides').width(CloudCameraList.hideArrows ? CloudCameraList.sliderWidth : CloudCameraList.sliderWidth - 104);
	CloudCameraList.container.width(CloudCameraList.sliderWidth);
	CloudCameraList.drawPager();
	CloudCameraList.fixView();
	return;
}

CloudCameraList.unauthorizedFail = function(){
	CloudCameraList.hideThrobber();
	CloudCameraList.container.css('width','220px').find('.slider_wrapper').html('').append(''
		+ CloudUI.polyglot.t("Unauthorized")
	);
} 

CloudCameraList.updateCamlist = function(){
	CloudCameraList.stopUpdatingCamList();
	CloudAPI.camerasList().done(function(response){
		if(response.objects){
			// detect diff
			var old_ids = [];
			for(var i = 0; i < CloudCameraList.structure.length; i++){
				old_ids.push(CloudCameraList.structure[i].id);
			}
			var new_ids = [];
			for(var i = 0; i < response.objects.length; i++){
				new_ids.push(response.objects[i].id);
			}
			var count = 0;
			for(var i = 0; i < new_ids.length; i++){
				if(old_ids.indexOf(new_ids[i]) == -1) count++;
			}
			for(var i = 0; i < old_ids.length; i++){
				if(new_ids.indexOf(new_ids[i]) == -1) count++;
			}
			if(count>0){
				console.log("[SLIDER] Cameras list was change");
				$('.sidebar').html('');
				CloudCameraList.dispose();
				// slider.currentPosition
				CloudCameraList.render(app);
				CloudCameraList.startUpdatingCamList();
			}else{
				CloudCameraList.structure = response.objects;
				CloudCameraList.updatePreview(app);
			}
		}
	}).fail(function(r){
		console.error(r);
		if(r.status && r.status == 401){
			CloudCameraList.unauthorizedFail();
		}
	});
}

CloudCameraList.Slide = function(params){
	var self = this;
	var obj = new Object();
	obj.params = params;
	_.extend(obj.params, CloudCameraList.config.slide);
	obj.render = function(){
		var item = $('<div class="slide"></div>');
		item.css({float:CloudCameraList.hideArrows ? 'initial' : 'left'})
		item.data('cid',this.params.id);
		var camstat = {
			'active' : CloudUI.polyglot.t('On'),
			'inactive' : CloudUI.polyglot.t('Off'),
			'inactive_by_scheduler' : CloudUI.polyglot.t('Off'),
			'offline' : CloudUI.polyglot.t('Disconnected'),
			'unauthorized' : CloudUI.polyglot.t('Wrong configuration')
		};
		var camstat_text = '';
		if(this.params.status && camstat[this.params.status]){
			camstat_text = camstat[this.params.status];
		};
		item.append($("<img class='slide-img " + this.params.status + "' id='capture_screen_" + this.params.id + "' border='0'>").on('error', 
			function(){
				if($(this).attr('src') != ''){
					console.error("could not load image: " + $(this).attr('src') + " For " + $(this).attr('id') + " change to default");
					$(this).attr('src','data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAIAAAACCAYAAABytg0kAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4AUNCR061qtorgAAABl0RVh0Q29tbWVudABDcmVhdGVkIHdpdGggR0lNUFeBDhcAAAAVSURBVAjXY/z//z8DAwMDAxMDFAAAMAYDAZWbBRUAAAAASUVORK5CYII%3D');
				}
			})
			.attr('src','data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAIAAAACCAYAAABytg0kAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4AUNCR061qtorgAAABl0RVh0Q29tbWVudABDcmVhdGVkIHdpdGggR0lNUFeBDhcAAAAVSURBVAjXY/z//z8DAwMDAxMDFAAAMAYDAZWbBRUAAAAASUVORK5CYII%3D')
		);
		var name = this.params.name != "" ?  this.params.name : CloudUI.polyglot.t('Noname');
		item.append($("<div class='slide_description'></div>")
			.append("<span class='main'>"+name+"</span>")
			// .append('<span class="italic">'+camstat_text+'</span>')
		);
		return item;
	};
	return obj;
}


CloudCameraList.calcSizes = function(){
	_.each(CloudCameraList.structure, function(el){CloudCameraList.slides.push( CloudCameraList.Slide(el))});
}
 
CloudCameraList.updatePreview = function(){
	// console.log("[SLIDER] update preview begin");
	var self = this;
	P2PProvider.cleanup();

	// beheivor for update preview for not p2p camera
	var preview = function(pos, cameraID){
		if(!SkyVR.hasAccessCameraPreview(cameraID)) return false;
		SkyVR.cameraPreview(cameraID).done(function(response){
			// console.log("[SLIDER] preview 2");
			// console.log(response);
			// preview not work
			var status = CloudCameraList.structure[pos].status;
			if(status == 'active'){
				$("#capture_screen_" + cameraID).attr("src",response.url);
			}
			var lastTime1 = new Date(response.time).getTime();
			var lastTime2 = new Date().getTime();
			// console.log("lastTime1: " + lastTime1);
			// console.log("lastTime2: " + lastTime2);
			// check date and call upgrade preview if need
			if(lastTime2 - lastTime1 > 60000){ // more than 1 minute
				if(CloudAPI.hasAccessCameraUpdatePreview(cameraID)){
					CloudAPI.cameraUpdatePreview(cameraID);
				}else{
					console.warn("Do not have permission to access updating preview");
				}
			}
		}).fail(function(xhr, ajaxOptions, thrownError){
			console.error("[SLIDER] preview fail " + xhr.status);
			if(xhr.status=404){
				if(SkyVR.hasAccessCameraUpdatePreview(cameraID)){
					SkyVR.cameraUpdatePreview(cameraID);
				}
			}
		});
	};

	// beheivor for update preview for p2p camera
	var p2p_preview = function(pos, cameraID){
		SkyVR.cameraP2PSettings(cameraID).done(function(response){
			if(response.p2p_streaming && response.p2p_streaming == true){
				// CloudCameraList.structure[pos].image_file = "files/images/camimg_default.jpg"; // will be init later
				CloudCameraList.structure[pos].p2p = response;
				P2PProvider.findP2PHost(CloudCameraList.structure[pos].id).done(function(web_url,rtmp_url){
					console.log("[DEBUG] web_url " + web_url);
					var status = CloudCameraList.structure[pos].status;
					if(status == 'active'){
						var new_img = web_url + "capture/ch0.jpg?time=" + Date.now();
						$("#capture_screen_" + cameraID).attr("src",new_img);
					}
				});
			}else{
				try{preview(pos, cameraID)}catch(e){ console.error(e)};
			}
		});
	};
	
	function tryPreview(i0, camid){
		SkyVR.cameraInfo(camid).done(function(cam){
			if(cam['p2p_streaming'] && cam['p2p_streaming'] == true){
				try{p2p_preview(i0, camid)}catch(e){ console.error(e)};
			}else{
				try{preview(i0, camid)}catch(e){ console.error(e)};
			}
		});
	};
		
	for(var i = 0; i < CloudCameraList.structure.length; i++){
		var status = CloudCameraList.structure[i].status;
		if(status == "active"){
			tryPreview(i, CloudCameraList.structure[i].id);
		}else{
			var cameraID = CloudCameraList.structure[i].id;
			$("#capture_screen_" + cameraID)
				.removeClass('active')
				.removeClass('inactive')
				.removeClass('inactive_by_scheduler')
				.removeClass('offline')
				.removeClass('unauthorized')
				.addClass(status);
			// $("#capture_screen_" + cameraID).attr("src",camimgs[status]);
		}
	}
	// console.log("[SLIDER] update preview end");
}
        
CloudCameraList.stopUpdatingCamList = function(){
	clearInterval(CloudCameraList.updateCamImages);
}

CloudCameraList.startUpdatingCamList = function(){
	CloudCameraList.stopUpdatingCamList();
	CloudCameraList.updateCamImages = setInterval(function(){
		console.log("[CAMLIST] updateCamImages");
		CloudCameraList.updateCamlist();
	}, 30000);
}

/* CloudMainPage implementation */

window.CloudMainPage = window.CloudMainPage || {}
window.CloudMainPage.initPanelButtons = function(el){
	el.find('#open-cloud-api-button').unbind().bind('click',function(){
		var url = "https://www.videoexpertsgroup.com/api/client.html?api_token=" + CloudAPI.config.apiToken.token + "&api_token_exp=" + CloudAPI.config.apiToken.expire;
		var win = window.open(url, '_blank');
		win.focus();
	});
}

/* EventList implementation */
window.EventList = function (event){
	var self = this;
	self.event = event;
	self.description = "Class EventList For SkyVR";
	self.buffer = new Array();
	
	// cache by every 3 hours
	self.durationGrid = 10800000;

	this.minifier0002sec = new Array();
	this.minifier0036sec = new Array();
	this.minifier0450sec = new Array();

	this.minifier = function(scale_sec, startTime, endTime){
		var st = self.normalizeT(startTime);
		var et = self.normalizeT(endTime);
		var res = [];
		var mini = '';
		if(scale_sec > 0 && scale_sec <= 15){
			mini = 'minifier0002sec';
		}else if(scale_sec > 15 && scale_sec <= 60){
			mini = 'minifier0036sec';
		}else if(scale_sec > 60 && scale_sec <= 700){
			mini = 'minifier0450sec';
		}
		if(self[mini]){
			for(var i = st; i <= et; i += self.durationGrid){
				if(self[mini][i]){
					res = res.concat(self[mini][i]);
				}
			}
		}
		return res;
	}

	this.applySortUniq = function(t){
		self.buffer[t].sort(function (a, b) {return a.time - b.time});
		var len = self.buffer[t].length;
		if(len > 1){
			var o = self.buffer[t][0];
			for (var i=1;i<len-1;i++){
				if(o.time == self.buffer[t][i].time){
					self.buffer[t].splice(i,1);
					i--;
					len = self.buffer[t].length;
				}else{
					o = self.buffer[t][i];
				}
			}
		}
	};

	this.removeBefore = function(time){
		function funcdel(t){
			var res = 0;
			if(self.buffer[t]){
				var len = self.buffer[t].length;
				self.buffer[t] = self.buffer[t].filter(function(el){ return el.startTime > time; })
				var removed = (len - self.buffer[t].length);
				if(self.buffer[t].length == 0){
					delete self.buffer[t];
					delete self.minifier0002sec[t];
					delete self.minifier0036sec[t];
					delete self.minifier0450sec[t];
				}else if(removed > 0){
					self.minifier0002sec[t] = self.makeMinifier(2, t);
					self.minifier0036sec[t] = self.makeMinifier(36, t);
					self.minifier0450sec[t] = self.makeMinifier(450, t);
				}
				res += removed;
			}
			return res;
		}
		var t = self.normalizeT(time);
		var prev_t = t - self.durationGrid;
		var res = funcdel(prev_t);
		res += funcdel(t);
		return res;
	}

	this.normalizeT = function(t){
		var tmp = t;
		tmp = tmp - tmp%1000;
		tmp = tmp - tmp % self.durationGrid;
		return tmp;
	}
	
	this.lock = false;
	this.append = function(res){
		if(this.lock){
			var res2 = res;
			setTimeout(function(){ self.append(res2); },100);
			return;
		}
		// console.log("Set eventlist lock");
		this.lock = true;
		try{
			if(!res.concat){
				console.error("[TIMELINE] res.concat");
				return;
			}
			// filter by camid
			var camid = SkyVR.cameraID();
            res = res.filter(function(e){ return e.camid == camid; });
            var for_uniq = [];
            var minT = undefined;
			var maxT = undefined;
			for(var i = 0; i < res.length; i++){
				res[i].isoTime = res[i].time;
				res[i].time = Date.parse(res[i].isoTime + "Z");
				if(res[i].thumb){
					delete res[i].thumb;
				}
				minT = minT == undefined ? res[i].time : Math.min(minT, res[i].time);
				maxT = maxT == undefined ? res[i].time : Math.max(maxT, res[i].time);

				var part = self.normalizeT(res[i].time);
				if(for_uniq.indexOf(part) == -1){
					for_uniq.push(part);
				}
				if(!self.buffer[part]){
					self.buffer[part] = [];
				}
				self.buffer[part].push(res[i]);
			}

			for(var i in for_uniq){
				var t = for_uniq[i];
				self.applySortUniq(t);
				self.minifier0450sec[t] = self.makeMinifier(450, t);
				self.minifier0036sec[t] = self.makeMinifier(36, t);
				self.minifier0002sec[t] = self.makeMinifier(2, t);
			}
			if(minT && maxT)
				self.event.trigger(self.event.TIMELINE_PORTION_DATA_LOADED, minT, maxT);
		}finally{
			// console.log("Unset eventlist lock");
			this.lock = false;
		}
	};
	this.applyConcat = this.append;

	this.makeMinifier = function(scale_sec, t){
		scale_sec = scale_sec || 30;
		var result = [];
		var u = [];
		var list = self.buffer[t];
		for(var i = 0; i < list.length; i++){
			var obj = list[i];
			var new_obj = {}
			new_obj.time = obj.time - obj.time % (scale_sec*1000);
			if(u.indexOf(new_obj.time) == -1){
				new_obj.name = obj.name;
				result.push(new_obj);
				u.push(new_obj.time);
			};
		}
		result.sort(function (a, b) {return a.time - b.time});
		return result;
		return [];
	};
};

/* RecordList implementation */

window.RecordList = function (event){
	var self = this;
	window.RecordListGlobal = self;
	self.event = event;
	self.description = "Class RecordList For VXGCloud";
	self.buffer = {};
	
	// cache by every 3 hours
	self.durationGrid = 10800000;
	
	self.isP2P = CloudAPI.isP2PStreaming();
	console.log("[RecordList] isP2P=" + self.isP2P);
	
	this.minifier01hour = new Array();
	this.minifier = function(startTime, endTime){
		var st = self.normalizeT(startTime);
		var et = self.normalizeT(endTime);
		var res = [];
		for(var i = st; i <= et; i += self.durationGrid){
			if(self.minifier01hour[i]){
				res = res.concat(self.minifier01hour[i]);
			}
		}
		return res;
	}
	
	this.firstStartTime = function(){
		var t = undefined;
		for(var i in self.buffer){
			t = t == undefined ? i : Math.min(i, t);
		}
		// TODO if list is empty
		var list = self.buffer[t] || [];
		if(list.length > 0){
			return list[0].startTime;
		}
		return undefined;
	}

	self.lastEndTime = function(){
		var t = undefined;
		for(var i in self.buffer){
			t = t == undefined ? i : Math.max(i, t);
		}
		var list = self.buffer[t] || [];
		if(list.length > 0){
			return list[list.length-1].endTime;
		}
		return undefined;
	}

	this.removeBefore = function(time){
		var t = self.normalizeT(time);
		var prev_t = t - self.durationGrid;
		var res = 0;
		if(self.buffer[prev_t]){
			var len = self.buffer[prev_t].length;
			self.buffer[prev_t] = self.buffer[prev_t].filter(function(el){ return el.startTime > time; })
			var removed = (len - self.buffer[prev_t].length);
			if(self.buffer[prev_t].length == 0){
				delete self.buffer[prev_t];
				delete self.minifier01hour[prev_t];
			}else if(removed > 0){
				self.minifier01hour[prev_t] = self.makeMinifier(prev_t);
				
			}
			res += removed;
		}
		if(self.buffer[t]){
			var len = self.buffer[t].length;
			self.buffer[t] = self.buffer[t].filter(function(el){ return el.startTime > time; })
			var removed = (len - self.buffer[t].length);
			if(self.buffer[t].length == 0){
				delete self.buffer[t];
				delete self.minifier01hour[t];
			}else if(removed > 0){
				self.minifier01hour[t] = self.makeMinifier(t);
			}
			res += removed;
		}
		return res;
	}

	this.atTime = function(time){
		var t = self.normalizeT(time);
		var prev_t = t - self.durationGrid;
		if(self.buffer[prev_t]){
			var list = self.buffer[prev_t];
			for(var i in list){
				if(time >= list[i].startTime && time < list[i].endTime) return list[i];
			}
		}
		if(self.buffer[t]){
			var list = self.buffer[t];
			for(var i in list){
				if(time >= list[i].startTime && time < list[i].endTime) return list[i];
			}
		}
		return undefined;
	};
	this.afterTime = function(time){
		var t = self.normalizeT(time);
		var max = self.normalizeT(self.lastEndTime() || 0);
		while(t <= max){
			if(self.buffer[t]){
				var list = self.buffer[t];
				for(var i in list){
					if(list[i].startTime >= time){
						return list[i];
					}
				}
			}
			t += self.durationGrid;
		}
		return undefined;
	};
	this.recordDuringOrAfter = function (t){
		return  self.atTime(t) || self.afterTime(t);
	};
	this.next = function(o){
		if(o) return this.afterTime(o.endTime - 999);
		return undefined;
	};

	this.normalizeT = function(t){
		var tmp = t;
		tmp = tmp - tmp%1000;
		tmp = tmp - tmp%self.durationGrid;
		return tmp;
	}
	
	this.applySortUniq = function(t){
		self.buffer[t].sort(function (a, b) {
			return a.startTime - b.startTime
		});
		var len = self.buffer[t].length;
		if(len > 1){
			var o = self.buffer[t][0];
			for (var i=1;i<len-1;i++){
				if(o.startTime == self.buffer[t][i].startTime){
					self.buffer[t].splice(i,1);
					i--;
					len = self.buffer[t].length;
				}else{
					o = self.buffer[t][i];
				}
			}
		}
	};

	this.lock = false;
	this.append = function(res, def){
		var d = def || $.Deferred();
		if(this.lock){
			var res2 = res;
			var d2 = d;
			setTimeout(function(){ self.append(res2,d2); },100);
			return d2.promise();
		}
		this.lock = true;
		try{
			if(!res.concat){
				console.error("[TIMELINE] res.concat");
				return;
			}
			// filter by camid
			var camid = CloudAPI.cameraID();
			res = res.filter(function(e){ return e.camid == camid; });
			var for_uniq = [];
			var minT = undefined;
			var maxT = undefined;
			for(var i = 0; i < res.length; i++){
				res[i].startTime = Date.parse(res[i].start + 'Z');
				res[i].endTime = Date.parse(res[i].end + 'Z');
				if(res[i].endTime < res[i].startTime){ // this logic because bad server format on camera;
					if(self.isP2P == true){
						res[i].endTime += 86400000;
					}else{
						console.error("Wrong times: ", res[i]);
						continue;
					}
				}
				minT = minT == undefined ? res[i].startTime : Math.min(minT, res[i].startTime);
				maxT = maxT == undefined ? res[i].endTime : Math.max(maxT, res[i].endTime);
				var part = self.normalizeT(res[i].startTime);
				if(for_uniq.indexOf(part) == -1){
					for_uniq.push(part);
				}
				if(!self.buffer[part]){
					self.buffer[part] = new Array();
				}
				self.buffer[part].push(res[i]);
			}

			for(var i in for_uniq){
				var t = for_uniq[i];
				self.applySortUniq(t);
				self.minifier01hour[t] = self.makeMinifier(t);
			}
			d.resolve();

			if(minT && maxT){
				self.event.trigger(self.event.TIMELINE_PORTION_DATA_LOADED, minT, maxT);
			}
		}finally{
			this.lock = false;
		}
		return d.promise();
	};

	this.takeHour = function(t){
		return t - t%3600000;
	}

	this.makeMinifier = function(t, precision_ms){
		precision_ms = precision_ms || 1000;
		var hours = [];
		var list = self.buffer[t];

		function pushArr(t1,t2){
			if(t2 <= t1) return;
			var h = self.takeHour(t2);
			if(self.takeHour(t1) != h){
				pushArr(t1,h-1);
				pushArr(h,t2);
				return;
			}
			var count = 0;
			for (var i=0;i<hours.length;i++){
				if(hours[i].h == h){
					hours[i].periods.push({ startTime: t1, endTime: t2})
					count++;
					break;
				}
			}
			if(count == 0){
				hours.push({h: h, periods: [{startTime: t1, endTime: t2}]});
			}
		}
		for(var i = 0; i < list.length; i++){
			var obj = list[i];
			pushArr(obj.startTime,obj.endTime);
		}

		hours.sort(function (a, b) {
			return a.h - b.h
		});

		var result = [];
		for(var i = 0; i < hours.length; i++){
			var periods = hours[i].periods;
			periods.sort(function (a, b) {
				return a.startTime - b.startTime
			});
			var p = undefined;
			for(var hi = 0; hi < periods.length; hi++){
				if(p == undefined){
					p = {
						startTime: periods[hi].startTime,
						endTime: periods[hi].endTime
					}
				}else{
					if(p.endTime >= periods[hi].startTime-precision_ms){
						p.endTime = periods[hi].endTime;
					}else{
						result.push({startTime: p.startTime, endTime: p.endTime});
						p = {
							startTime: periods[hi].startTime,
							endTime: periods[hi].endTime
						}
					}
				}
			}
			if(p != undefined){
				result.push({startTime: p.startTime, endTime: p.endTime});
			}
		}
		return result;
		return [];
	};
	
	this.checkCache = function(){
		for(var t in self.buffer){
			console.log(t);
			var ar = self.buffer[t];
			var len = ar.length;
			for(var i = 0; len; i++){
				if(i+1 < len){
					if(ar[i].startTime > ar[i+1].startTime){
						console.log("not sorted ", ar[i]);
						console.log("not sorted ", ar[i+1]);
					}
				}
			}
		}
	}
};

/* Timeline implementation */

window.Timeline = window.Timeline || {};
window.Timeline.model = window.Timeline.model || {};
window.Timeline.model.time = Date.now();

window.Timeline.getDuration = function(e){
	return Timeline.duration;
}

window.Timeline.locked = false;

window.Timeline.lock = function(){
	Timeline.locked = true;
}

window.Timeline.unlock = function(){
	Timeline.locked = false;
}


// technical page
window.CloudUI = window.CloudUI || {};

CloudUI.getPathToPlayerSwf = function(){
	if(localStorage.getItem("player_swf") != null){
		return localStorage.getItem("player_swf");
	}
	return cc.custom_videojs_swf ? cc.custom_videojs_swf : "swf/video-js-custom-vxg.swf";
}

CloudUI.htmlDialog = function(opt){
	return $('<div class="box-modal" id="' + opt.id + '">'
	+ '	<div class="list-content">'
	+ '		<div class="settings-popup camera-settings-popup dialog-popup">'
	+ '			<div class="header">'
	+ '				<p>' + opt.title + '</p>'
	+ '				<img class="box-modal_close arcticmodal-close" src="./files/images/camera_setting/close_white.svg">'
	+ '				<div class="clear"></div>'
	+ '			</div>'
	+ '			<div class="popup-wrapper dialog-content">'
	+ '			</div>'
	+ '		</div>'
	+ '	</div>'
	+ '</div>');
};

CloudUI.showSpecialSettings = function(opt){
	var c = CloudUI.htmlDialog({id: 'special-settings', title: 'Special Settings'});

	c.find('.dialog-content').append(''
		+ '<div class="caption">Load player swf:</div>'
		+ '<select id="player_swf">'
		+ '		<option value="">Use default</option>'
		+ '		<option value="swf/video-js-custom-SkyVR-min-latency.swf">Minimal Latency</option>'
		+ '</select>'
		+ '<div class="caption">Please <button id="reload_page">Reload page</button> after any changes</div>'
		+ '<div class="footer"></div>');

	if(localStorage.getItem("player_swf") == null){
		c.find('#player_swf').val("");
	}else{
		c.find('#player_swf').val(localStorage.getItem("player_swf"));
	}

	c.find('#player_swf').change(function() {
		var t = $( "#player_swf" ).val();
		if(t == ""){
			localStorage.removeItem("player_swf");
		}else{
			localStorage.setItem("player_swf", t);
		}
	});

	c.find('#reload_page').unbind().bind('click', function(){
		location.reload();
	});

	$.arcticmodal({
		content: c
	});
}

$(document).bind('keydown', function(e){
		if (e.ctrlKey && e.keyCode == 'I'.charCodeAt(0)) {
		CloudUI.showSpecialSettings();
		return false;
	}
});
