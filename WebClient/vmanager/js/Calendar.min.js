window.Calendar=new function(){this.description="Calendar player";var e=this;this.activeDate=null,this.activeMonthDate={month:1,date:1},this.curActiveDays={},this.data=[],this.hashTable=[],this.init=!1,this.timeouts=[],this.curActiveDays={},this.event=null,this.initialize=function(e){this.init=!0,this.event=e,this.curActiveDays=[],Calendar.activeDate=new Date(SkyVR.getCurrentTimeUTC()),this._prepareData([]),this.buildCalendar()},this.getMonthNum=function(e){return e.getUTCMonth()+1},this.nextMonth=function(){var e=new Date(Calendar.activeDate);return e.setUTCDate(1),e.setUTCMonth(e.getUTCMonth()+1),e},this.prevMonth=function(){var e=new Date(Calendar.activeDate);return e.setUTCDate(1),e.setUTCMonth(e.getUTCMonth()-1),e},this.drawActivityDate=function(e,t){if(Calendar.activeMonthDate.month!=e||Calendar.activeMonthDate.date!=t){Calendar.activeMonthDate.month=e,Calendar.activeMonthDate.date=t;for(var a=$(".calendar .days strong"),r=0;a.length>r;r++);}},this.renderCalendar=function(){console.log("[CALENDAR] Render called");var e=this;if(void 0==e.init)return console.log("[CALENDAR] Render ended. activeSession is undefined"),void 0;var t=function(t,a){return void 0==e.init?(console.log("[CALENDAR] Render ended. activeSession is undefined"),void 0):(e.data=a.objects,e._prepareData(e.data),e.buildCalendar(),e.bindEvents(),console.log("[CALENDAR] Render ended"),void 0)};e._prepareData([]),e.buildCalendar();var a=SkyVR.cache.cameraInfo();if(console.log("[CALENDAR] Camera cache ",a),console.log("[CALENDAR] Camera cameraID ",CloudAPI.config.cameraID),console.log("[CALENDAR] is p2p_streaming: ",CloudAPI.isP2PStreaming()),CloudAPI.isP2PStreaming()){if(console.log("[CALENDAR] Camera is P2P"),!a)return console.log("[CALENDAR] Camera did not found"),void 0;if(a&&"active"!=a.status)return console.log("[CALENDAR] Camera is not active"),void 0;var r=$.Deferred();r.done(function(e){console.log("[CALENDAR] Data recived start render"),t(!1,e)}).fail(function(){console.log("[CALENDAR] Data NOT recived start render & try get data after 10 sec ")}),e.buildCalendar(),P2PProvider.getActivity(r)}else console.log("[CALENDAR] Camera is Cloud mode"),SkyVR.storageActivity().done(function(e){t(!1,e)})},this.fixView=function(){var e=new Date(Calendar.activeDate);e.setUTCDate(1),e.setUTCMonth(e.getUTCMonth()-1),e=this.activeMonth(e.getUTCFullYear(),Calendar.getMonthNum(e));var t=new Date(Calendar.activeDate);t.setUTCDate(1);var a=t.getUTCFullYear();t.setUTCMonth(t.getUTCMonth()+1),t=this.activeMonth(t.getUTCFullYear(),Calendar.getMonthNum(t));var r=new Date(Calendar.activeDate).format("mmmm");$(".calendar .current-month").text(app.polyglot.t(r)+" "+a),$(".calendar .month").removeClass("next prev"),t&&$(".calendar .month").addClass("next"),e&&$(".calendar .month").addClass("prev");var n="<span>"+app.polyglot.t("calendar_sunday_short")+"</span>"+"<span>"+app.polyglot.t("calendar_monday_short")+"</span>"+"<span>"+app.polyglot.t("calendar_tuesday_short")+"</span>"+"<span>"+app.polyglot.t("calendar_wednesday_short")+"</span>"+"<span>"+app.polyglot.t("calendar_thursday_short")+"</span>"+"<span>"+app.polyglot.t("calendar_friday_short")+"</span>"+"<span>"+app.polyglot.t("calendar_saturday_short")+"</span>";$(".calendar .header").html(n)},this._prepareData=function(t){var a=Object.create({});this.maxDate=null,_.each(t,function(t){var r=new Date(t);e.maxDate=e.maxDate&&e.maxDate>r?e.maxDate:r;var n=r.getUTCFullYear(),o=r.getUTCMonth()+1,i=r.getUTCDate();a[n]=a[n]||{},a[n][o]=a[n][o]||{},a[n][o][i]=a[n][o][i]=!0}),this.hashTable=a,console.log(a)},this.getDaysInMonths=function(){var e=new Date(Calendar.activeDate);e.setUTCDate(1);var t=e.getUTCMonth(),a=28;for(e.setUTCDate(a);t==e.getUTCMonth();)a++,e.setUTCDate(a);return a--,a},this.setDaysWithActivity=function(e){var t=e||new Date(e);if(!this.activeMonth(t.getUTCFullYear(),Calendar.getMonthNum(t)))return[];var a=t.getFullYear(),r=Calendar.getMonthNum(t),n=this.hashTable[a][r];this.curActiveDays=_.isObject(n)?n:[]},this.activeMonth=function(e,t){return _.isObject(this.hashTable[e])&&_.isObject(this.hashTable[e][t])},this.onClickDay=function(){$(".calendar .days strong").removeClass("active"),$(this).addClass("active"),e.event.trigger(e.event.CALENDAR_DATE_CHANGED,$(this).data())},this.buildCalendar=function(){var t=new Date(Calendar.activeDate);t.setUTCDate(1);var a=e.getDaysInMonths(Calendar.activeDate);e.setDaysWithActivity(Calendar.activeDate),e.outer=$(".calendar .days"),e.outer.html("");for(var r=function(e){var t=new Date(e);t.setUTCDate(0);for(var a=t.getUTCDate(),r=[];a;)r.push(a),a-=1;return r},n=r(t),o=t.getUTCDay(),i=o-1;i>=0;i--)this.outer.append($("<span style='color: #969696;'>"+n[i]+"</span>"));n.reverse();for(var i=0;a>i;i++){var c=i+1;e.curActiveDays[c]?this.outer.append($("<strong>"+c+"</strong>").data("day",c).data("month",t.getUTCMonth()).data("year",t.getUTCFullYear()).click(Calendar.onClickDay)):this.outer.append($("<span>"+c+"</span>"))}t.setUTCDate(a);for(var s=0,i=t.getUTCDay();6>i;i++)this.outer.append($("<span style='color: #969696;'>"+n[s]+"</span>")),s++;var l=$(".days").children().length;if(42>l)for(;42!=$(".days").children().length;)this.outer.append($("<span style='color: #969696;'>"+n[s]+"</span>")),s++;this.curActiveDays=[],this.fixView()},this.bindEvents=function(){$(".calendar .month .next").unbind().click(function(){Calendar.activeDate=Calendar.nextMonth(),e.buildCalendar()}),$(".calendar .month .prev").unbind().click(function(){Calendar.activeDate=Calendar.prevMonth(),e.buildCalendar()})},this.dispose=function(){$(".calendar .days").html(""),$(".calendar .current-month").text(""),$(".calendar .month").removeClass("next prev"),$(".calendar .header").html(""),e.init=!1,e.activeDate=null}};