window.P2PProvider=new function(){var e=this;this.cache={cameras:[],queries:{}},this.rx=/\/data\/(\d{4})_(\d{2})_(\d{2})\/(\d{6})_(\d{2})(\d{2})(\d{2})_(\d{2})(\d{2})(\d{2})(_([AC\d]+)){0,1}\.mp4[ ]*(\d+\.\d+)(\w)/,this.buildRecord=function(e,r,t){var o=this.rx.exec(e);if(null==o)return console.error("[P2P] Problem parse: ",e),void 0;var a={camid:r,start:o[1]+"-"+o[2]+"-"+o[3]+"T"+o[5]+":"+o[6]+":"+o[7],end:o[1]+"-"+o[2]+"-"+o[3]+"T"+o[8]+":"+o[9]+":"+o[10],size:Math.round(parseFloat(o[13])*("M"==o[14]?1048576:1024)),url:t+e.split(" ")[0]};return a},this.buildEvent=function(e,r){var t=this.rx.exec(e);if(null==t)return console.error("[P2P] Problem parse: ",e),void 0;if(t[12]){var o=t[12];if(1!=o.length||"C"!=o){var a="";a=1==o.length&&"A"==o?"sound":"motion";var n={camid:r,name:a,time:t[1]+"-"+t[2]+"-"+t[3]+"T"+t[5]+":"+t[6]+":"+t[7]};return n}}},this.runBuildTests=function(){function e(e,r){if(!e)return console.error("Expected not null object. "+r.url),void 0;for(var t in e)e[t]!=r[t]&&console.error("Invalid '"+t+"', expected: '"+r[t]+"' got: '"+e[t]+"'")}var r=P2PProvider.buildRecord("/data/2016_01_02/160102_115000_115454_A1.mp4       8.26M",219,"http://localhost"),t=P2PProvider.buildRecord("/data/2016_01_02/160102_115000_115454.mp4       8.26M",219,"http://localhost"),o={camid:219,size:8661238,start:"2016-01-02T11:50:00",end:"2016-01-02T11:54:54",url:"http://localhost/data/2016_01_02/160102_115000_115454_A1.mp4"};e(r,o),o.url="http://localhost/data/2016_01_02/160102_115000_115454.mp4",e(t,o),P2PProvider.buildEvent("/data/2016_01_02/160102_115000_115454.mp4       8.26M",219,"http://localhost");var a=P2PProvider.buildEvent("/data/2016_01_02/160102_115000_115454_A1.mp4       8.26M",220,"http://localhost"),n=P2PProvider.buildEvent("/data/2016_01_02/160102_115000_115454_A.mp4       8.26M",220,"http://localhost"),c={time:"2016-01-02T11:50:00",camid:220,name:"motion"};e(a,c),c.name="sound",e(n,c)},this.hasInCache=function(r){return e.cache.cameras[r]&&null!=e.cache.cameras[r]},this.setToCache=function(r,t,o){e.cache.cameras[r].ip=t,e.cache.cameras[r].ports={},e.cache.cameras[r].ports.main_port=o.main_port,e.cache.cameras[r].ports.rtmp_port=o.rtmp_port,e.cache.cameras[r].ports.rtsp_port=o.rtsp_port,e.cache.cameras[r].ports.web_port=o.web_port,e.cache.cameras[r].wait_response=!1,e.cache.cameras[r].web_url="http://"+t+":"+o.web_port+"/",e.cache.cameras[r].rtmp_url="rtmp://"+t+":"+o.rtmp_port+"/live/video1"},this.queryCameraStatus=function(r,t,o){var a=$.Deferred(),n=new XMLHttpRequest,c=Date.now();return e.cache.queries[c]=n,n.onreadystatechange=function(){n.readyState==XMLHttpRequest.DONE&&(200==n.status?(console.log("Winner "+r+":"+t),a.resolve(n.responseText),delete e.cache.queries[c]):400==n.status?(a.reject(),delete e.cache.queries[c]):(a.reject(),delete e.cache.queries[c]))},n.open("GET","http://"+r+":"+t+"/httpapi/GetState?"+Date.now(),!0),n.timeout=o,n.ontimeout=function(){console.error("Timeout: http://"+r+":"+t+"/httpapi/GetState"),a.reject(),delete e.cache.queries[c]},n.send(),a},this.cleanup=function(){for(var r in e.cache.queries)e.cache.queries[r]&&e.cache.queries[r].abort();e.cache.cameras=[]},this.findP2PHost=function(r){var t=$.Deferred();if(!SkyVR.isP2PStreaming_byId(r))return t.reject(),t;var o=SkyVR.cache.cameraInfo(r);if("active"!=o.status)return console.error("[P2PPROVIDER] camera is inactive"),t.reject(),t;if(void 0==o.p2p)return console.error("[P2PPROVIDER] could not find p2p in camera info"),t.reject(),t;if(void 0==o.p2p.local)return console.error("[P2PPROVIDER] could not find p2p.local in camera info"),t.reject(),t;var a=o.p2p.local.web_port;a=0==a?80:a;var n=o.p2p.public?o.p2p.public.web_port:0;if(n=0==n?80:n,e.hasInCache(o.id))return"pending"==e.cache.cameras[o.id].d.state()?e.cache.cameras[o.id].d:(t.resolve(e.cache.cameras[o.id].web_url,e.cache.cameras[o.id].rtmp_url),t);e.cache.cameras[o.id]={ip:null,ports:{},web_url:null,rtmp_url:null,wait_response:!0,try_local_ip:"wait",try_external_ip:"wait",try_public_ip:"wait",d:t},o.p2p.tunnel&&o.p2p.tunnel.web_url&&(console.log("[DEBUG] Can use tunnel: "+o.p2p.tunnel.web_url),e.cache.cameras[o.id].tunnel_web_url=o.p2p.tunnel.web_url);var c=o.ip;if(e.queryCameraStatus(c,a,1e4).done(function(){if("pending"==t.state()){e.setToCache(o.id,c,o.p2p.local);var r=e.cache.cameras[o.id];t.resolve(r.web_url,r.rtmp_url)}e.cache.cameras[o.id].try_local_ip="found"}).fail(function(){console.log("Host '"+c+":"+a+"' did not found "),e.cache.cameras[o.id].try_local_ip="not_found"}),o.p2p.public!==void 0){var i=o.p2p.public.ip;o.p2p.public.ip!==void 0&&""!=i&&i!=c&&e.queryCameraStatus(i,n,1e4).done(function(){"pending"==t.state()&&(e.setToCache(o.id,i,o.p2p.public),t.resolve(e.cache.cameras[o.id].web_url,e.cache.cameras[o.id].rtmp_url)),e.cache.cameras[o.id].try_public_ip="found"}).fail(function(){console.log("[P2PProvider] public_ip, d.state():"+t.state()),console.log("Host '"+i+":"+n+"' did not found "),e.cache.cameras[o.id].try_public_ip="not_found"});var s=o.p2p.public.external_ip;s!=c&&s!=i&&e.queryCameraStatus(s,n,1e4).done(function(){"pending"==t.state()&&(e.setToCache(o.id,s,o.p2p.public),t.resolve(e.cache.cameras[o.id].web_url,e.cache.cameras[o.id].rtmp_url)),e.cache.cameras[o.id].try_external_ip="found"}).fail(function(){console.log("[P2PProvider] external_ip, d.state():"+t.state()),console.log("Host '"+s+":"+n+"' did not found "),e.cache.cameras[o.id].try_external_ip="not_found"})}else e.cache.cameras[o.id].try_public_ip="not_found",e.cache.cameras[o.id].try_external_ip="not_found";var l=0,u=10,d=setInterval(function(){return l++,console.log("wait_sec: "+l),"resolved"==t.state()?(clearInterval(d),console.log("[P2PProvider] Found host"),void 0):("not_found"==e.cache.cameras[o.id].try_local_ip&&"not_found"==e.cache.cameras[o.id].try_public_ip&&"not_found"==e.cache.cameras[o.id].try_external_ip&&(console.log("[P2PProvider] Not found host"),clearInterval(d),e.cache.cameras[o.id].tunnel_web_url?(console.log("[P2PProvider] Using tunnel, d.state(): "+t.state()),e.cache.cameras[o.id].web_url=e.cache.cameras[o.id].tunnel_web_url,t.resolve(e.cache.cameras[o.id].web_url,e.cache.cameras[o.id].rtmp_url)):(console.log("[P2PProvider] Tunnel not found"),t.reject())),l>u&&(clearInterval(d),console.log("[P2PProvider] "),t.reject()),void 0)},1e3);return t},this.makeUrlWithParams=function(e,r){var t="";for(k in r)t.length>0&&(t+="&"),t+=encodeURIComponent(k)+"="+encodeURIComponent(r[k]);return e+(t.length>0?"?"+t:"")},this.queryGet=function(e){var r=$.Deferred();if(e===void 0)return r.reject("URL is undefined"),r;if(e&&"null:undefined"==e.split("/")[2])return console.error("URL is undefined"),r.reject("URL is undefined"),r;var t=new XMLHttpRequest;return t.onreadystatechange=function(){t.readyState==XMLHttpRequest.DONE&&(200==t.status?r.resolve(t.responseText):r.reject("URL ["+e+"] did not found (xmlhttp.status: "+t.status+")"))},t.open("GET",e,!0),t.send(),r.promise()},this.getWebHost=function(){var e=$.Deferred(),r=SkyVR.cameraID();return P2PProvider.findP2PHost(r).done(function(r,t){console.log("p2p: web_url: "+r+"; rtmp_url: "+t),e.resolve(r+"httpapi/SearchData",r)}).fail(function(){console.log(),e.reject()}),e},this.getPages=function(r){var t=Object.create(r);t.getpagenum=0;var o=$.Deferred();return e.getWebHost().done(function(r){r=e.makeUrlWithParams(r,t),e.queryGet(r).done(function(e){try{var r=parseInt(e.split("=")[1],10);o.resolve(r)}catch(t){o.reject()}}).fail(function(e){o.reject(e)})}).fail(function(){o.reject()}),o.promise()},this.parseDate=function(e,r){var t=[],o=[e[1],e[2],e[3]];return t=t.concat(o.map(function(e){return parseInt(e)}),[r.slice(0,2),r.slice(2,4),r.slice(4)].map(function(e){return parseInt(e)})),t[1]=t[1]-1,t=new Date(t)},this.loadData=function(r,t){var o=SkyVR.cameraID(),a=$.Deferred(),n=new Date(r),c=n.getUTCFullYear()+"_"+("00"+(n.getUTCMonth()+1)).slice(-2)+"_"+("00"+n.getUTCDate()).slice(-2);console.log("[P2P] dt "+c);var i={objects:[]},s={objects:[]},l={action:"getlist",date:c};return P2PProvider.getPages(l).done(function(r){if(0==r)return a.resolve(i,s),void 0;if(!r)return a.reject("Could not get pages"),void 0;r=t||r;var n=Math.floor(r/10)+1;P2PProvider.getWebHost().done(function(r,t){for(var c=[],u=0;n>u;u++)l.page=10*u+1,l.pagenum=10,url=P2PProvider.makeUrlWithParams(r,l),c.push(P2PProvider.queryGet(url));$.when.apply($,c).done(function(){for(var r=[],n=0;arguments.length>n;n++){var c=arguments[n].split(/[\n\r]+/);c=c.filter(function(e){return""!=e}),r=_.union(r,c)}for(var n=0;r.length>n;n++){var l=e.buildRecord(r[n],o,t);l&&i.objects.push(l);var u=e.buildEvent(r[n],o);u&&s.objects.push(u)}i.objects.reverse(),s.objects.reverse(),a.resolve(i,s)}).fail(function(){console.log("some errors"),a.reject("some errors")})})}).fail(function(){console.error("could not get pages"),a.reject("some errors")}),a.promise()},this.getActivity=function(e){var r=this,t=e||$.Deferred();return params={action:"getroot"},P2PProvider.getWebHost().done(function(e){return null==e?(console.log("[CAMERA-DATAPROVIDER] host is null"),t.reject(),void 0):(url=P2PProvider.makeUrlWithParams(e,{action:"getroot",getpagenum:0}),P2PProvider.queryGet(url).done(function(o){var a=1;try{a=parseInt(o.split("=")[1],10)}catch(n){return console.log("[CAMERA-DATAPROVIDER] none pages"),t.reject(),void 0}if(!a||a&&0==a)return t.resolve({objects:[]}),void 0;for(var c=[],i=0;a>i;i++)url=P2PProvider.makeUrlWithParams(e,{action:"getroot",page:i+1}),c.push(P2PProvider.queryGet(url));$.when.apply($,c).done(function(){for(var o=[],a=0;arguments.length>a;a++){var n=arguments[a].split(/[\n\r]+/);n=n.filter(function(e){return""!=e}),o=_.union(o,n)}for(var c=[],a=0;o.length>a;a++)url=P2PProvider.makeUrlWithParams(e,{action:"getlist",date:o[a],getbeginend:1}),c.push(P2PProvider.queryGet(url));$.when.apply($,c).done(function(){for(var e=[],o=0;arguments.length>o;o++){var a=arguments[o].split(/[\n\r]+/);a=a.filter(function(e){return""!=e}),e=_.union(e,a)}r.timezoneOffset||(r.timezoneOffset=SkyVR.getOffsetTimezone());for(var n={objects:[]},o=0;e.length>o;o++){var c=P2PProvider.buildRecord(e[o]);c.startTime=new Date(c.start+"Z").getTime()+r.timezoneOffset;var i=new Date(c.startTime);i=i.getUTCFullYear()+"-"+("00"+(i.getUTCMonth()+1)).slice(-2)+"-"+("00"+i.getUTCDate()).slice(-2),0>n.objects.indexOf(i)&&n.objects.push(i)}t.resolve(n)}).fail(function(){console.log("[CAMERA-DATAPROVIDER] One from several query (getbeginend) has fail"),t.reject()})}).fail(function(){console.log("[CAMERA-DATAPROVIDER] One from several query has fail"),t.reject()})}).fail(function(){console.error("[CAMERA-DATAPROVIDER] Problem with getroot")}),void 0)}),t.promise()}};